package FindBalance

import (
	"Logger"
	"Service"
	"crypto/rsa"
	"fmt"
	"sync"
)
type  TransactionCoinRow struct {
    
}

type  TransactionListCoin [] transactionsCoinRow

type BalanceService interface {
	Service.Service
	FindBalance(sender rsa.PublicKey) (float64)
    findAndLock(amount float64 )(float64 , error)
}

type BalanceImplementation struct {
	LoggerService Logger.LoggerService
    BlockChainService  *  BlockChainCoinsService
}

func (balance *BalanceImplementation) Construct() error {
	balance.LoggerService = &Logger.Logger{ServiceName: "balance-service"}
	err := balance.LoggerService.Construct()
	if err != nil {
		return err
	}
	balance.LoggerService.Log("service  created ")

	return nil
}
func (balance *BalanceImplementation) FindBalance(sender rsa.PublicKey) (float64) {
	const lookingTemplate = "Look for  \n%v\n balance"
	lookingMessage := fmt.Sprintf(lookingTemplate, sender)
	balance.LoggerService.Log(fmt.Sprintf("Start %s" , lookingMessage))
    amount  := balance.BlockChainService.FindBalance()
	balance.LoggerService.Log(fmt.Sprintf("Commit %s" , lookingMessage))
	return amount
}
func (balance *BalanceImplementation) findAndLock(amount float64) (float64 , error ) {
	const lookingTemplate = "Look for  \n%v\n balance And Lock"
	lookingMessage := fmt.Sprintf(lookingTemplate, sender)
	balance.LoggerService.Log(fmt.Sprintf("Start %s" , lookingMessage))
    amount  , err := balance.BlockChainService.findAndLock(amount)
	balance.LoggerService.Log(fmt.Sprintf("Commit %s" , lookingMessage))
	return amount ,err 
}
// Mocks
// MockFindBalance
type MockFindBalance struct {
	Amount                 float64
	Err                    error
	FindBalanceCalledTimes int
	Locked                 bool
	LockedCall             int
	UnlockedCall           int
}

func (balance *MockFindBalance) Construct() error {
	return nil
}
func (balance *MockFindBalance) FindBalance(sender rsa.PublicKey) (float64, error) {
	balance.FindBalanceCalledTimes++
	return balance.Amount, balance.Err
}
func (balance *MockFindBalance) LockBalance() {
	balance.Locked = true
	balance.LockedCall++
}
func (balance *MockFindBalance) UnLockBalance() {
	balance.Locked = false
	balance.UnlockedCall++
}
